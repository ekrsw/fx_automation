# 強化されたシグナル生成システム実装ガイド

## 概要

このドキュメントでは、fx_system_requirements.mdの仕様に基づいて実装された100点満点のスコアリングシステムとエリオット波動分析機能について説明します。

## 実装されたコンポーネント

### 1. ElliottWaveAnalyzer (`app/services/elliott_wave_analyzer.py`)

エリオット波動理論に基づく波動パターン検出とフィボナッチ比率分析を提供します。

#### 主要機能
- **インパルス波（5波動）パターン検出**
  - 第1波から第5波までの完全なサイクル検出
  - エリオット波動の3つの基本ルールの検証
  - フィボナッチ比率による信頼度計算

- **修正波（ABC）パターン検出**
  - 3波動修正パターンの識別
  - リトレースメント比率の計算

- **フィボナッチ計算**
  - リトレースメントレベル（23.6%, 38.2%, 50%, 61.8%, 78.6%）
  - エクステンションレベル（127.2%, 161.8%, 200%, 261.8%）
  - プロジェクション（目標値）計算

#### 波動スコアリング
```python
wave_scores = {
    '1': 30,  # 第1波（新トレンド開始）
    '2': 10,  # 第2波（調整）
    '3': 40,  # 第3波（最強の推進波）
    '4': 10,  # 第4波（調整）
    '5': 20,  # 第5波（トレンド完了）
    'A': 15,  # A波（修正開始）
    'B': 10,  # B波（調整）
    'C': 15   # C波（修正完了）
}
```

### 2. EnhancedSignalGenerator (`app/services/enhanced_signal_generator.py`)

100点満点のスコアリングシステムと複数時間軸分析を実装しています。

#### スコアリング内訳（100点満点）

##### 1. トレンド強度（30点）
- **連続的高値・安値更新**（最大15点）
  - Higher Highs + Higher Lows（上昇トレンド）
  - Lower Highs + Lower Lows（下降トレンド）
  - 最大5回の更新で満点

- **スイングポイント間の角度**（最大10点）
  - 急峻な価格変動ほど高得点
  - price_change / previous_price * 1000で算出

- **複数時間軸での方向一致**（最大5点）
  - 3つ以上の時間軸でトレンド一致：5点
  - 2つの時間軸でトレンド一致：3点

##### 2. エリオット波動位置（40点）
- **第3波開始**: 40点（最優先）
- **第1波開始**: 30点
- **第5波開始**: 20点
- **修正波**: 5-15点
- 信頼度による調整適用

##### 3. 技術的確度（20点）
- **フィボナッチ比率適合度**（最大10点）
  - ±5%以内で満点
  - ±10%以内で部分点

- **複数時間軸での一致性**（最大10点）
  - 日足+4時間足の方向一致で満点

##### 4. 市場環境（10点）
- **ボラティリティ適正性**（最大5点）
  - ATRが過去20日平均の80-120%で満点
  - 0.8%-1.2%の範囲が理想

- **流動性時間帯**（最大5点）
  - NY時間（22:00-6:00 JST）: 5点
  - ロンドン時間（16:00-24:00 JST）: 3点
  - 東京時間（9:00-15:00 JST）: 2点

### 3. 複数時間軸分析

#### 対応時間軸
```python
timeframes = {
    'M5': 5,      # 5分足（エントリータイミング）
    'M15': 15,    # 15分足
    'H1': 60,     # 1時間足
    'H4': 240,    # 4時間足（メイントレンド）
    'D1': 1440    # 日足（大局トレンド）
}
```

#### 分析フロー
1. 各時間軸でのデータ取得とリサンプリング
2. テクニカル分析実行（ダウ理論、ZigZag、エリオット波動）
3. プライマリ時間軸での総合スコア計算
4. シグナル判定と推奨事項生成

## API エンドポイント

### 1. 包括的シグナル分析
```
GET /api/v1/enhanced-signals/comprehensive/{symbol}
```
パラメータ:
- `symbol`: 通貨ペア（USDJPY, EURUSD等）
- `timeframe`: メイン分析時間軸（デフォルト: H4）
- `min_score`: 最小スコア閾値（デフォルト: 60.0）

### 2. エリオット波動分析
```
GET /api/v1/enhanced-signals/elliott-wave/{symbol}
```
パラメータ:
- `symbol`: 通貨ペア
- `data_points`: 分析データポイント数（デフォルト: 200）

### 3. スコア内訳詳細
```
GET /api/v1/enhanced-signals/score-breakdown/{symbol}
```

### 4. 全市場スキャン
```
GET /api/v1/enhanced-signals/market-scan
```
パラメータ:
- `min_score`: 最小スコア閾値
- `timeframe`: 分析時間軸
- `limit`: 最大結果数

## 使用例

### バックテストでの使用

強化されたシグナル生成器はバックテストエンジンに統合されており、従来のシンプルなテクニカル指標ベースのシグナルから、100点満点のスコアリングシステムに置き換えられています。

```python
# app/services/backtest_engine.py内での使用
signal = await self._generate_swing_signal(data, parameters)
# 内部的にEnhancedSignalGeneratorを使用
```

### マルチペア管理での使用

マルチペア管理サービスでも強化されたスコアリングシステムが活用されています。

```python
# app/services/multi_pair_manager.py内での使用
comprehensive_signal = enhanced_signal_generator.generate_comprehensive_signal(
    symbol=symbol,
    primary_timeframe='H4'
)
```

## 相関調整機能

要件仕様通り、既存ポジションとの相関を考慮した調整が実装されています：

```python
# 強い逆相関（-0.7以下）の場合
if correlation <= -0.7:
    adjusted_score = original_score * 0.7  # 30%減点

# 強い正相関（0.7以上）の場合
if correlation >= 0.7:
    adjusted_score = original_score * 0.8  # 20%減点
```

## 運用ルール

### エントリー条件
- **最小スコア**: 60点以上（設定可能）
- **高スコア優先**: 80点以上で強いシグナル
- **複数時間軸一致**: 日足+4時間足の方向一致が推奨

### 入替条件
- **スコア差**: 既存ポジションより15点以上高いシグナルで入替検討
- **最小保持期間**: 4時間以上の保持必須（パラメータで調整可能）

### リスク管理
- **1取引あたりの最大リスク**: 2%
- **ATRベースのストップロス**: ATR×2.0
- **リスクリワード比**: 1:3（テイクプロフィット）

## テストとデバッグ

### テストスクリプト
```bash
python test_enhanced_signals.py
```

このスクリプトは以下をテストします：
1. エリオット波動分析の動作確認
2. 100点満点スコアリングシステムの検証
3. バックテストエンジンとの統合テスト

### ログ出力
詳細な分析ログが出力されるため、スコア算出過程を追跡できます：

```
Enhanced swing signal generated: buy with score 72
Score breakdown: {
    'trend_strength': 22,
    'elliott_wave': 30,
    'technical_accuracy': 12,
    'market_environment': 8
}
```

## 今後の拡張予定

1. **機械学習統合**: 過去のパフォーマンスデータを学習してスコア重みを最適化
2. **リアルタイム最適化**: 市場状況に応じたパラメータ動的調整
3. **追加テクニカル指標**: ハーモニックパターン、ボリューム分析等の統合
4. **詳細バックテスト**: 100点満点システムの過去データでの検証

## まとめ

この実装により、fx_system_requirements.mdで指定された以下の要件が満たされています：

✅ 100点満点のスコアリング方式
✅ トレンド強度（30点）- ダウ理論ベース
✅ エリオット波動位置（40点）- 第3波: 40点、第1波: 30点、第5波: 20点
✅ 技術的確度（20点）- フィボナッチ比率適合度、複数時間軸一致
✅ 市場環境（10点）- ボラティリティ適正性、流動性時間帯
✅ 相関調整機能
✅ 15点以上の差での入替検討
✅ 複数時間軸分析（日足+4時間足）

このシステムにより、より精密で信頼性の高いトレーディングシグナルの生成が可能になりました。