# FX自動売買システム要件定義書 v2.0
**実装検証に基づく改訂版**

## 改訂履歴
- v1.0: 2024年初版（理想的な要件）
- v2.0: 2025年6月8日（実装結果を踏まえた現実的な要件に改訂）

## 1. システム概要

### 1.1 システム名
FX自動売買システム（実用性重視のスイングトレード戦略）

### 1.2 システム目的
**実用性と安全性のバランスを重視**したスイングトレード戦略により、USD/JPYを中心とした通貨ペアの自動売買を行う。

### 1.3 基本方針
- **実証済み技術の優先**: 複雑な理論より実用性を重視
- **段階的拡張**: 1ペア → マルチペア → 高度機能の順序
- **リスク管理**: 破滅的損失の完全回避
- **収益性確保**: 取引機会と安全性の適切なバランス

### 1.4 v1.0からの主要変更点
- エリオット波動の重要度を下げ、実装しやすい指標を重視
- 100点満点システムを段階的に導入（当初は簡易版）
- マルチペア対応を将来目標に変更（まずは単一ペアで完成度向上）

## 2. 機能要件

### 2.1 取引対象

#### Phase 1（現在実装済み）
- **対象通貨ペア**: USD/JPY（メインペア）
- **取引戦略**: ダウ理論ベースのスイングトレード + 技術指標補強
- **同時ポジション数**: 最大2ペア
- **データ**: 1時間足メイン、複数時間軸分析（簡易版）

#### Phase 2（6ヶ月以内目標）
- **対象通貨ペア**: USD/JPY、EUR/USD、GBP/USD（3ペア監視）
- **同時ポジション数**: 最大3ペア
- **相関調整**: 基本的な相関回避機能

#### Phase 3（1年以内目標）
- **対象通貨ペア**: USD系6ペア全監視
- **高度な相関調整**: 動的ペア選択
- **複数時間軸**: 完全な複数時間軸分析

### 2.2 シグナル評価基準

#### 2.2.1 段階的スコアリングシステム

**Phase 1: 簡易スコアリング（現在）**
```
総合スコア = 基本スコア（60点） + ボーナス（40点）

基本スコア:
- トレンド方向: ±30点（移動平均ベース）
- RSI条件: ±15点（過熱感チェック）  
- モメンタム: ±15点（価格変動率）

ボーナススコア:
- ボラティリティ適正: +10点
- 時間軸一致性: +10点
- フィボナッチ近接: +10点
- 時間帯: +10点
```

**Phase 2: 強化スコアリング（6ヶ月後）**
```
100点満点システム（v1.0より実用的に調整）

1. トレンド強度（40点）← v1.0の30点から強化
   - ダウ理論での連続更新: 25点
   - トレンド継続性: 15点

2. テクニカル確度（30点）← v1.0の20点から強化  
   - 複数時間軸一致: 15点
   - フィボナッチ適合: 10点（±10%に緩和）
   - RSI/MACD確認: 5点

3. エリオット波動（20点）← v1.0の40点から縮小
   - 明確な5波パターン: 20点
   - 修正波パターン: 10点
   - 不明確: 0点

4. 市場環境（10点）← v1.0と同じ
   - ボラティリティ適正: 5点
   - 流動性時間帯: 5点
```

#### 2.2.2 エントリー閾値（実証ベース）
- **Phase 1**: 50-60点（取引機会確保）
- **Phase 2**: 65-75点（精度向上）
- **緊急回避**: 35点以下で強制決済検討

#### 2.2.3 実装済み運用ルール
- **評価頻度**: 1時間毎（リアルタイムは将来実装）
- **最小保持期間**: 4時間（頻繁売買回避）
- **最大保持期間**: 168時間（7日、塩漬け回避）

### 2.3 リスク管理（実装済み）

#### 2.3.1 資金管理（検証済み設定）
- **1取引あたりの最大リスク**: 1-2%（実装では1%推奨）
- **全体の最大ドローダウン**: 10%（v1.0の15%から強化）
- **連続損失制限**: 5回連続負けで一時停止

#### 2.3.2 ポジションサイズ計算（実装済み）
- ストップロス距離に基づく自動計算
- ATRベースのボラティリティ調整
- 最小ロット: 0.01、最大ロット: 資金の10%相当

#### 2.3.3 ストップロス・テイクプロフィット（確定済み）

**ストップロス**
- **第1優先**: ダウ理論ベース（直近スイングポイント ± 0.2%）
- **第2優先**: ATR×2（ボラティリティ対応）
- **フォールバック**: 固定2%

**テイクプロフィット**  
- **第1優先**: フィボナッチ1.618エクステンション
- **第2優先**: リスクリワード比1:2.5
- **トレーリングストップ**: 1%距離で追跡

### 2.4 取引時間制限（実装済み）
- **重要指標時**: 米雇用統計、FOMC前後1時間は新規エントリー停止
- **低流動性時**: 日本時間3:00-7:00は新規エントリー停止
- **スプレッド監視**: 平常時の2倍以上で取引停止

## 3. 技術要件（実装済み + 改善点）

### 3.1 システム構成（確定）
```
[Python FastAPI] ←HTTP→ [MQL5 EA] ←→ [MetaTrader5] ←→ [ブローカー]
     ↓
[SQLiteDB] (市場データ・取引履歴・ログ)
```

### 3.2 実装済み技術スタック

#### 3.2.1 Python側（動作確認済み）
- **フレームワーク**: FastAPI + uvicorn
- **主要ライブラリ**: pandas, numpy, sqlite3
- **分析機能**: 自作テクニカル分析（TA-Lib依存なし）

#### 3.2.2 MQL5側（動作確認済み）
- **データ取得EA**: 履歴データ自動ダウンロード
- **通信機能**: HTTP POST/GET通信
- **データ形式**: JSON（1時間足OHLCV）

### 3.3 パフォーマンス要件（実測ベース）
- **バックテスト処理時間**: 3ヶ月データで2分以内
- **リアルタイム分析**: 1ペアあたり5秒以内
- **メモリ使用量**: 100MB以内（1年分データ）

### 3.4 実装済みAPI

#### 3.4.1 基本API
- `GET /status`: システム状態確認
- `GET /api/v1/backtest/results`: バックテスト結果
- `POST /api/v1/backtest/run`: バックテスト実行
- `POST /api/v1/mt5/receive-historical-batch`: MT5からのデータ受信

#### 3.4.2 分析API
- `GET /api/v1/analysis/technical`: テクニカル分析
- `GET /api/v1/signals/current`: 現在のシグナル
- `GET /api/v1/market-data/count`: データ件数確認

## 4. 開発完了状況と今後の計画

### 4.1 完了済みフェーズ

#### ✅ Phase 1-5: 基本システム（完了）
1. **インフラ**: FastAPI + SQLite + MQL5通信
2. **データ収集**: MT5からの自動データ取得
3. **基本分析**: ダウ理論 + テクニカル指標
4. **バックテスト**: 完全なバックテストエンジン
5. **リスク管理**: ポジションサイズ・ストップロス計算

#### ✅ Phase 6: スイングトレード戦略（完了）
- ダウ理論ベースのスイングポイント検出
- 100点満点スコアリングシステム（簡易版）
- エリオット波動検出（基本版）
- フィボナッチターゲット計算

### 4.2 優先改善項目（今後1-3ヶ月）

#### 🔶 Phase 7: 実用性向上（優先度: 高）
**目標**: 取引機会の創出と収益性向上
1. **スコア閾値最適化**: 65点 → 50-55点
2. **エリオット波動簡素化**: 検出条件緩和
3. **パラメータ調整**: ATR期間、MA期間の最適化
4. **複数戦略併用**: 高精度戦略 + 機会確保戦略

#### 🔶 Phase 8: パフォーマンス改善（優先度: 中）
1. **処理速度向上**: 重い計算の最適化
2. **メモリ効率**: 大量データ処理の改善
3. **エラーハンドリング**: 例外処理の強化

### 4.3 将来実装項目（6ヶ月以降）

#### Phase 9: マルチペア対応
1. **3ペア同時監視**: USD/JPY, EUR/USD, GBP/USD
2. **相関調整機能**: 基本的な相関回避
3. **ペア選択ロジック**: 最高スコア3ペア選択

#### Phase 10: 高度機能
1. **リアルタイム監視**: 5分毎の自動評価
2. **機械学習**: パラメータ自動最適化
3. **アラート機能**: Slack/Email通知

## 5. 品質管理・テスト要件

### 5.1 バックテスト基準（確定）
- **最低テスト期間**: 3ヶ月以上
- **必要データ量**: 2,000件以上
- **成功基準**: 
  - 勝率 > 40%
  - 最大DD < 10%
  - プロフィットファクター > 1.2
  - 月平均取引数: 2-10回

### 5.2 フォワードテスト
- **デモ運用**: 最低1ヶ月の継続運用
- **小額実運用**: デモ成功後、最小ロットで実運用
- **段階拡大**: 3ヶ月安定後にロット拡大

## 6. 実装課題と解決策

### 6.1 判明した主要課題

#### 6.1.1 100点満点システムの過度な厳格性
**問題**: 75点閾値でも取引機会0回
**解決策**: 
- 閾値を50-55点に調整
- エリオット波動の重みを40点→20点に削減
- ボーナススコア制度導入

#### 6.1.2 エリオット波動検出の複雑性
**問題**: 精密な波動検出は実装困難
**解決策**:
- 簡易検出アルゴリズムの採用
- 明確なパターンのみ検出
- 不明時は0点（エントリー阻害しない）

#### 6.1.3 処理速度の問題
**問題**: 3ヶ月バックテストで2分超
**解決策**:
- 重い計算の事前計算・キャッシュ化
- 並行処理の導入
- データ量の最適化

### 6.2 実証された有効な手法
1. **ダウ理論**: スイングポイント検出は有効
2. **リスク管理**: ドローダウン0%達成
3. **データ品質**: MT5からの安定データ取得
4. **システム安定性**: 長時間運用での安定動作

## 7. 運用指針

### 7.1 段階的運用計画
1. **Phase 1**: バックテスト最適化（1ヶ月）
2. **Phase 2**: デモ口座運用（1ヶ月）
3. **Phase 3**: 小額実運用（3ヶ月）
4. **Phase 4**: 本格運用開始

### 7.2 監視・保守
- **日次**: ポジション状況・システム稼働確認
- **週次**: パフォーマンス分析・パラメータ調整検討
- **月次**: 総合評価・戦略見直し

### 7.3 緊急時対応
- **システム障害**: 手動決済への切り替え手順
- **相場急変**: 全ポジション強制決済基準
- **連続損失**: 一時停止・原因分析手順

## 8. 成功指標（KPI）

### 8.1 技術指標
- **システム稼働率**: 99%以上
- **処理性能**: 1ペア分析5秒以内
- **データ品質**: 欠損率1%以下

### 8.2 取引成績指標
- **年間収益率**: 10-30%
- **最大ドローダウン**: 10%以下
- **勝率**: 40%以上
- **プロフィットファクター**: 1.3以上

### 8.3 運用指標
- **取引頻度**: 月2-10回
- **平均保持期間**: 1-7日
- **リスク管理**: 設定通りの厳格な実行

## 9. まとめ

### 9.1 v1.0からの主要改善点
1. **実用性重視**: 理想論から実装可能な現実的要件へ
2. **段階的実装**: 複雑機能の段階的導入
3. **実証ベース**: バックテスト結果に基づく調整
4. **収益性確保**: 安全性と取引機会のバランス

### 9.2 次期開発の重点
1. **取引機会創出**: 0回 → 月数回の適切な頻度
2. **収益性向上**: 現在0% → 年10-30%目標
3. **実用性**: デモ → 実運用への移行準備

この改訂要件定義は、実装とバックテスト結果に基づく現実的な仕様として、今後の開発指針とする。